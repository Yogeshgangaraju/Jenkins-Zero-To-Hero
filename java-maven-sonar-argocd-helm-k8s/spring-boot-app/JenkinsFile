pipeline {
    agent {
        docker {
            image 'maven:3.9.6-eclipse-temurin-17'  // Java 17 + Maven 3.9.x
            args '-v /var/jenkins_home/.m2:/root/.m2 -u root'  // reuse maven cache + run as root
        }
    }

    environment {
        // You can define these in Jenkins global environment or credentials if needed
        SONAR_TOKEN = credentials('sonar-token')  // recommended instead of plain text
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Maven Build & Package') {
            steps {
                dir('java-maven-sonar-argocd-helm-k8s/spring-boot-app') {
                    sh 'java -version'
                    sh 'mvn --version'
                    sh 'mvn clean package -DskipTests'
                }
            }
        }

        stage('Static Code Analysis') {
            when {
                expression { currentBuild.result == null || currentBuild.result == 'SUCCESS' }
            }
            steps {
                dir('java-maven-sonar-argocd-helm-k8s/spring-boot-app') {
                    withSonarQubeEnv('SonarQube') {  // must match the name in Jenkins → Manage Jenkins → SonarQube servers
                        sh '''
                            echo "Running SonarQube analysis..."
                            mvn sonar:sonar \
                                -Dsonar.projectKey=spring-boot-demo \
                                -Dsonar.host.url=${SONAR_HOST_URL} \
                                -Dsonar.login=${SONAR_TOKEN}
                        '''
                    }
                }
            }
        }

        stage('Build and Push Docker Image') {
            when {
                expression { currentBuild.result == null || currentBuild.result == 'SUCCESS' }
            }
            steps {
                dir('java-maven-sonar-argocd-helm-k8s/spring-boot-app') {
                    script {
                        docker.withRegistry('https://index.docker.io/v1/', 'docker-hub-credentials') {
                            def image = docker.build("yourusername/spring-boot-demo:${env.BUILD_NUMBER}")
                            image.push()
                            image.push('latest')
                        }
                    }
                }
            }
        }

        stage('Update Deployment File') {
            when {
                expression { currentBuild.result == null || currentBuild.result == 'SUCCESS' }
            }
            steps {
                script {
                    // Example: update image tag in deployment yaml
                    sh '''
                        sed -i "s|image:.*|image: yourusername/spring-boot-demo:${BUILD_NUMBER}|" \
                            k8s/deployment.yaml
                        git config user.email "jenkins@yourcompany.com"
                        git config user.name "Jenkins"
                        git add k8s/deployment.yaml
                        git commit -m "Update image tag to ${BUILD_NUMBER}" || echo "No changes to commit"
                        git push origin HEAD:main
                    '''
                }
            }
        }
    }

    post {
        always {
            // Clean workspace if desired
            cleanWs()
        }
        success {
            echo "Pipeline completed successfully!"
        }
        failure {
            echo "Pipeline failed - check logs"
        }
    }
}
