pipeline {
    agent {
        docker {
            image 'maven:3.9.6-eclipse-temurin-17'  // Java 17 + Maven 3.9.x
            args '-v /var/run/docker.sock:/var/run/docker.sock -v /var/jenkins_home/.m2:/root/.m2 -u root'
            // Mounts host Docker socket + Maven cache + runs as root
        }
    }

    environment {
        SONAR_TOKEN = credentials('sonar-token')  // Your Sonar token credential
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Maven Build & Package') {
            steps {
                dir('java-maven-sonar-argocd-helm-k8s/spring-boot-app') {
                    sh 'java -version'
                    sh 'mvn --version'
                    sh 'mvn clean package -DskipTests'
                }
            }
        }

        stage('Static Code Analysis') {
            when {
                expression { currentBuild.result == null || currentBuild.result == 'SUCCESS' }
            }
            steps {
                dir('java-maven-sonar-argocd-helm-k8s/spring-boot-app') {
                    withSonarQubeEnv('SonarQube') {
                        sh '''
                            echo "Running SonarQube analysis..."
                            mvn sonar:sonar \
                                -Dsonar.projectKey=spring-boot-demo \
                                -Dsonar.host.url=${SONAR_HOST_URL} \
                                -Dsonar.login=${SONAR_TOKEN}
                        '''
                    }
                }
            }
        }

        stage('Build and Push Docker Image') {
            when {
                expression { currentBuild.result == null || currentBuild.result == 'SUCCESS' }
            }
            steps {
                dir('java-maven-sonar-argocd-helm-k8s/spring-boot-app') {
                    withCredentials([usernamePassword(credentialsId: 'docker-cred',
                                                     usernameVariable: 'DOCKER_USER',
                                                     passwordVariable: 'DOCKER_PASS')]) {
                        sh '''
                            # Build the image with build-number tag
                            docker build -t yogeshawsci/spring-boot-demo:${BUILD_NUMBER} .
                            
                            # Create the :latest tag from the same image
                            docker tag yogeshawsci/spring-boot-demo:${BUILD_NUMBER} yogeshawsci/spring-boot-demo:latest
                            
                            # Debug: confirm both tags exist locally
                            docker images | grep spring-boot-demo
                            
                            # Login to Docker Hub with PAT
                            echo "${DOCKER_PASS}" | docker login -u "${DOCKER_USER}" --password-stdin
                            
                            # Push both tags
                            docker push yogeshawsci/spring-boot-demo:${BUILD_NUMBER}
                            docker push yogeshawsci/spring-boot-demo:latest
                            
                            # Logout for security
                            docker logout
                        '''
                    }
                }
            }
        }

        stage('Update Deployment File') {
            when {
                expression { currentBuild.result == null || currentBuild.result == 'SUCCESS' }
            }
            steps {
                withCredentials([string(credentialsId: 'github', variable: 'GITHUB_TOKEN')]) {
                    sh '''
                        git config --global user.email "jenkins@ci"
                        git config --global user.name "Jenkins"
                        
                        # Update image tag in deployment.yaml
                        sed -i "s|image:.*|image: yogeshawsci/spring-boot-demo:${BUILD_NUMBER}|" k8s/deployment.yaml
                        
                        git add k8s/deployment.yaml
                        git commit -m "Update image tag to ${BUILD_NUMBER}" || echo "No changes to commit"
                        
                        # Push to your real GitHub repo using PAT
                        git push https://${GITHUB_TOKEN}@github.com/Yogeshgangaraju/Jenkins-Zero-To-Hero.git HEAD:main
                    '''
                }
            }
        }
    }

    post {
        always {
            cleanWs()
        }
        success {
            echo "Pipeline completed successfully!"
        }
        failure {
            echo "Pipeline failed - check logs"
        }
    }
}
